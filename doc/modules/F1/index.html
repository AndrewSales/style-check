<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta http-equiv="Generator" content="xqdoca - https://github.com/quodatum/xqdoca"><title>style-check - xqDocA
        </title><link rel="shortcut icon" type="image/x-icon" href="../../resources/xqdoc.png"><link rel="stylesheet" type="text/css" href="../../resources/prism/prism.css"><link rel="stylesheet" type="text/css" href="../../resources/page.css"><link rel="stylesheet" type="text/css" href="../../resources/query.css"><link rel="stylesheet" type="text/css" href="../../resources/base.css"></head><body class="home" id="top"><div id="main"><div><h1><span class="badge badge-info">http://www.andrewsales.com/style-check</span>&nbsp;
			<small>library module</small><div style="float:right"><span class="badge badge-dark" title="Private">P</span></div></h1><nav id="toc"><h2><a href="../../index.html">style-check</a>
                / Module
       </h2><h3><a id="contents"></a><span class="">http://www.andrewsales.com/style-check</span></h3><ol class="toc"><li><a href="#summary"><span class="secno">1 </span><span class="content">Summary</span></a></li><li><a href="#related"><span class="secno">2 </span><span class="content">Related</span></a></li><li><a href="#imports"><span class="secno">2 </span><span class="content">Imports</span></a></li><li><a href="#variables"><span class="secno">3 </span><span class="content">Variables</span></a><ol class="toc"><li><a href="#$sc:DOCX_CONTENT"><span class="secno">3.1</span><span class="content">$sc:DOCX_CONTENT</span><div style="float:right"></div></a></li><li><a href="#$sc:HALT_ON_INVALID"><span class="secno">3.2</span><span class="content">$sc:HALT_ON_INVALID</span><div style="float:right"></div></a></li><li><a href="#$sc:OPT_DEBUG"><span class="secno">3.3</span><span class="content">$sc:OPT_DEBUG</span><div style="float:right"></div></a></li><li><a href="#$sc:STYLE_SCHEMA"><span class="secno">3.4</span><span class="content">$sc:STYLE_SCHEMA</span><div style="float:right"></div></a></li><li><a href="#$sc:UNZIP_DIR"><span class="secno">3.5</span><span class="content">$sc:UNZIP_DIR</span><div style="float:right"></div></a></li></ol></li><li><a href="#functions"><span class="secno">4 </span><span class="content">Functions</span></a><ol class="toc"><li><a href="#sc:build-manifest"><span class="secno">4.1</span><span class="content" title="">sc:build-manifest<div style="float:right"></div></span></a></li><li><a href="#sc:check"><span class="secno">4.2</span><span class="content" title="">sc:check<div style="float:right"></div></span></a></li><li><a href="#sc:debug"><span class="secno">4.3</span><span class="content" title="">sc:debug<div style="float:right"><span class="badge badge-dark" title="Private">P</span></div></span></a></li><li><a href="#sc:ensure-contents"><span class="secno">4.4</span><span class="content" title="">sc:ensure-contents<div style="float:right"></div></span></a></li><li><a href="#sc:ensure-file"><span class="secno">4.5</span><span class="content" title="">sc:ensure-file<div style="float:right"></div></span></a></li><li><a href="#sc:ensure-format"><span class="secno">4.6</span><span class="content" title="">sc:ensure-format<div style="float:right"></div></span></a></li><li><a href="#sc:simplify-styles"><span class="secno">4.7</span><span class="content" title="">sc:simplify-styles<div style="float:right"></div></span></a></li><li><a href="#sc:unzip"><span class="secno">4.8</span><span class="content" title="">sc:unzip<div style="float:right"></div></span></a></li><li><a href="#sc:unzip-path"><span class="secno">4.9</span><span class="content" title="">sc:unzip-path<div style="float:right"></div></span></a></li><li><a href="#sc:validate"><span class="secno">4.10</span><span class="content" title="">sc:validate<div style="float:right"></div></span></a></li></ol></li><li><a href="#namespaces"><span class="secno">5 </span><span class="content">Namespaces</span></a></li><li><a href="#restxq"><span class="secno">6 </span><span class="content">RestXQ</span></a></li><li><a href="#source"><span class="secno">7 </span><span class="content">Source</span></a></li></ol></nav><section id="summary"><h2>Summary</h2><div><p xmlns:xqdoc="http://www.xqdoc.org/1.0">Module of BaseX XQuery functions to provide style-checking functionality
for Microsoft Word documents.</p>

<p xmlns:xqdoc="http://www.xqdoc.org/1.0">Tested under BaseX 9.5.</p>
The target Word XML format is that in the namespace:
	<code xmlns:xqdoc="http://www.xqdoc.org/1.0">http://schemas.openxmlformats.org/wordprocessingml/2006/main</code>.

<p xmlns:xqdoc="http://www.xqdoc.org/1.0">The main entry point is sc:check(), which takes one or more paths to *.docx
documents. Each of these is unzipped, simplified to consist of elements
describing paragraph and inline styles, then validated against the style
DTD - see path given in $sc:STYLE_SCHEMA.</p>

<h2 xmlns:xqdoc="http://www.xqdoc.org/1.0">APPROACH</h2>
<ol xmlns:xqdoc="http://www.xqdoc.org/1.0"><li>does path exist?</li>
<li>is it a DOCX?</li>
<li>is it a valid zip?</li>
<li>unzip it</li>
<li>is it a valid DOCX (does it contain <code>word/document.xml</code>)?</li>
<li>transform it to simplified styles</li>
<li>validate the result with custom validator</li>
<li>return the resulting report</li>
</ol>

<p xmlns:xqdoc="http://www.xqdoc.org/1.0">TODO: use <code>$sc:UNZIP_DIR</code></p></div><dl><dt>Tags</dt><dd><p>__source : lib/style-check.xqm</p></dd></dl></section><section id="related"><h2>Related documents</h2><table class="data"><thead><th>View</th><th>Description</th><th>Format</th></thead><tbody><tr><td><a href="xqdoc.xml">xqdoc</a></td><td>xqDoc xml file from the source module</td><td>xml</td></tr><tr><td><a href="xqparse.xml">xqparse</a></td><td>xqparse xml file from the source module</td><td>xml</td></tr></tbody></table></section><section id="imports"><h2>Imports</h2><p>
    This module is imported by
    <span class="badge badge-info">2</span> modules, it imports
    <span class="badge badge-info">0</span> modules.
    </p><div style="display: flex;width:100%; justify-content: space-between;"><div style="width:40%;"><div style="text-align: right;"><span><a href="../../modules/F2/index.html" title="test/tests.xqm">http://www.andrewsales.com/style-check-tests</a></span></div><div style="text-align: right;"><span><a href="../../modules/F3/index.html" title="utils/test.xq">test.xq</a></span></div></div><div style="display: flex; flex-direction: column; justify-content: center;"><div><div>imports</div>→</div><div class="badge badge-info">this</div><div><div>imports</div>→</div></div><div style="width:40%;">(None)</div></div></section><section id="variables"><h2>Variables</h2><div class="div3"><h3><a id="$sc:DOCX_CONTENT"></a><a id="{http://www.andrewsales.com/style-check}$DOCX_CONTENT"></a>3.1&nbsp;$sc:DOCX_CONTENT</h3><dl><dt class="label">Summary</dt><dd>the zip entries to be extracted from DOCX</dd><dt class="label">Type</dt><dd>element(archive:entry)+</dd></dl></div><div class="div3"><h3><a id="$sc:HALT_ON_INVALID"></a><a id="{http://www.andrewsales.com/style-check}$HALT_ON_INVALID"></a>3.2&nbsp;$sc:HALT_ON_INVALID</h3><dl><dt class="label">Summary</dt><dd>string of the halt-on-invalid validation option</dd><dt class="label">Type</dt><dd>xs:string</dd></dl></div><div class="div3"><h3><a id="$sc:OPT_DEBUG"></a><a id="{http://www.andrewsales.com/style-check}$OPT_DEBUG"></a>3.3&nbsp;$sc:OPT_DEBUG</h3><dl><dt class="label">Summary</dt><dd>debugging flag</dd><dt class="label">Type</dt><dd>xs:string</dd></dl></div><div class="div3"><h3><a id="$sc:STYLE_SCHEMA"></a><a id="{http://www.andrewsales.com/style-check}$STYLE_SCHEMA"></a>3.4&nbsp;$sc:STYLE_SCHEMA</h3><dl><dt class="label">Summary</dt><dd>location of the style schema applied during validation</dd><dt class="label">Type</dt><dd>xs:anyURI</dd></dl></div><div class="div3"><h3><a id="$sc:UNZIP_DIR"></a><a id="{http://www.andrewsales.com/style-check}$UNZIP_DIR"></a>3.5&nbsp;$sc:UNZIP_DIR</h3><dl><dt class="label">Summary</dt><dd>where the contents of the DOCX will be extracted to (not currently used)</dd><dt class="label">Type</dt><dd>xs:string</dd></dl></div></section><section id="functions"><h2>Functions</h2><div class="div3"><h3><a id="sc:build-manifest"></a><a id="{http://www.andrewsales.com/style-check}build-manifest#1"></a>4.1&nbsp;sc:build-manifest<div style="float:right"><a href="#sc:build-manifest">#</a></div></h3><p>Arities: <span style="margin-left:1em"><a href="#{http://www.andrewsales.com/style-check}build-manifest#1">sc:build-manifest#1</a></span></p><dt class="label">Summary</dt><dd>Build the manifest for the Word XML files extracted.</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">sc:build-manifest</code>
		  ( 
			<code class="arg">$docs</code><code class="as">&nbsp;as&nbsp;</code><code class="type">xs:string+</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0">element(files)</xqdoc:type></code></div></dd><dt class="label">Parameters</dt><dd><ul><li>docs<code class="as">&nbsp;as&nbsp;</code><code class="return-type">xs:string+</code> the absolute URI(s) of the document(s) to process</li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">element(files)</code>the manifest, each document in the batch represented by <code xmlns:xqdoc="http://www.xqdoc.org/1.0">&lt;file src='...'/&gt;</code></li></ul></dd><details><summary>Invokes 4 functions from 1 modules </summary><ul><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}ensure-contents#1" title="lib/style-check.xqm">sc:ensure-contents#1</a></span></li><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}ensure-file#1" title="lib/style-check.xqm">sc:ensure-file#1</a></span></li><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}ensure-format#3" title="lib/style-check.xqm">sc:ensure-format#3</a></span></li><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}unzip#3" title="lib/style-check.xqm">sc:unzip#3</a></span></li></ul></details><details><summary>Invoked by 3 functions from 2 modules</summary><ul><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}check#2" title="lib/style-check.xqm">sc:check#2</a></span></li><li><span><a href="../../modules/F2/index.html#{http://www.andrewsales.com/style-check-tests}build-manifest#0" title="test/tests.xqm">sct:build-manifest#0</a></span></li><li><span><a href="../../modules/F2/index.html#{http://www.andrewsales.com/style-check-tests}simplify-styles#0" title="test/tests.xqm">sct:simplify-styles#0</a></span></li></ul></details><details><summary>Source</summary><pre><code class="language-xquery">function sc:build-manifest($docs as xs:string+)
as element(files)
{
  &lt;files&gt;{
    $docs !
    (
      sc:ensure-file(.) =&gt; sc:ensure-format() =&gt; sc:unzip(),
      sc:ensure-contents(.)
    )
  }&lt;/files&gt;
}</code></pre></details></div><div class="div3"><h3><a id="sc:check"></a><a id="{http://www.andrewsales.com/style-check}check#2"></a>4.2&nbsp;sc:check<div style="float:right"><a href="#sc:check">#</a></div></h3><p>Arities: <span style="margin-left:1em"><a href="#{http://www.andrewsales.com/style-check}check#2">sc:check#2</a></span></p><dt class="label">Summary</dt><dd>Process one or more word-processing documents.
Currently only DOCX format is supported.
Options are: 
<ul xmlns:xqdoc="http://www.xqdoc.org/1.0"><li>debug (Boolean): whether to emit debugging messages via trace()</li>
<li>halt-on-invalid (Boolean): whether to halt processing on the first invalid 
document returned by <code>sc:validate()</code></li></ul></dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">sc:check</code>
		  ( 
			<code class="arg">$docs</code><code class="as">&nbsp;as&nbsp;</code><code class="type">xs:string+</code>, <code class="arg">$options</code><code class="as">&nbsp;as&nbsp;</code><code class="type">map(*)</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="*">item()</xqdoc:type>*</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>docs<code class="as">&nbsp;as&nbsp;</code><code class="return-type">xs:string+</code> the absolute URI(s) of the document(s) to process</li><li>options<code class="as">&nbsp;as&nbsp;</code><code class="return-type">map(*)</code> map of options</li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">item() *</code>manifest of file paths for further processing</li></ul></dd><details><summary>Invokes 5 functions from 2 modules </summary><ul><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}build-manifest#1" title="lib/style-check.xqm">sc:build-manifest#1</a></span></li><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}debug#2" title="lib/style-check.xqm">sc:debug#2</a></span></li><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}simplify-styles#1" title="lib/style-check.xqm">sc:simplify-styles#1</a></span></li><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}validate#3" title="lib/style-check.xqm">sc:validate#3</a></span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2005/xpath-functions}string-join#2</span></li></ul></details><details><summary>Invoked by 2 functions from 2 modules</summary><ul><li><span><a href="../../modules/F2/index.html#{http://www.andrewsales.com/style-check-tests}check#0" title="test/tests.xqm">sct:check#0</a></span></li><li><span><a href="../../modules/F3/index.html#{http://www.w3.org/2005/xquery-local-functions}xqDoc-main#0" title="utils/test.xq">local:xqDoc-main#0</a></span></li></ul></details><details><summary>Source</summary><pre><code class="language-xquery">function sc:check(
  $docs as xs:string+,
  $options as map(*)
)
{
  let $_ := sc:debug('check(): ' || string-join($docs, ' '), $options)
  let $manifest := sc:build-manifest($docs)
  let $_ := sc:debug('manifest=' || $manifest, $options)
  return sc:simplify-styles($manifest) =&gt; sc:validate($options)
}</code></pre></details></div><div class="div3"><h3><a id="sc:debug"></a><a id="{http://www.andrewsales.com/style-check}debug#2"></a>4.3&nbsp;sc:debug<div style="float:right"><a href="#sc:debug">#</a></div></h3><p>Arities: <span style="margin-left:1em"><a href="#{http://www.andrewsales.com/style-check}debug#2">sc:debug#2</a><span class="badge badge-dark" title="Private">P</span></span></p><dt class="label">Summary</dt><dd>Emit debugging messages to the console.</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">sc:debug</code>
		  ( 
			<code class="arg">$msg</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>, <code class="arg">$options</code><code class="as">&nbsp;as&nbsp;</code><code class="type">map(*)</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="*">item()</xqdoc:type>*</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>msg<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code> the contents of the message to display</li><li>options<code class="as">&nbsp;as&nbsp;</code><code class="return-type">map(*)</code> map of options (if 'debug' is set to true(), messages are emitted)</li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">item() *</code></li></ul></dd><details><summary>Invokes 1 functions from 1 modules </summary><ul><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2005/xpath-functions}trace#1</span></li></ul></details><details><summary>Invoked by 2 functions from 1 modules</summary><ul><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}check#2" title="lib/style-check.xqm">sc:check#2</a></span></li><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}validate#2" title="lib/style-check.xqm">sc:validate#2</a></span></li></ul></details><details><summary>Annotations</summary><table class="data"><tbody><tr><td><code class="function">%private</code></td><td><code class="arg">()</code></td></tr></tbody></table></details><details><summary>Source</summary><pre><code class="language-xquery">function sc:debug($msg as item()*, $options as map(*))
{
  if($options?($sc:OPT_DEBUG))
  then trace('[DEBUG]:' || $msg)
  else ()
}</code></pre></details></div><div class="div3"><h3><a id="sc:ensure-contents"></a><a id="{http://www.andrewsales.com/style-check}ensure-contents#1"></a>4.4&nbsp;sc:ensure-contents<div style="float:right"><a href="#sc:ensure-contents">#</a></div></h3><p>Arities: <span style="margin-left:1em"><a href="#{http://www.andrewsales.com/style-check}ensure-contents#1">sc:ensure-contents#1</a></span></p><dt class="label">Summary</dt><dd>Check that all expected content is present in the DOCX archive.</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">sc:ensure-contents</code>
		  ( 
			<code class="arg">$docx</code><code class="as">&nbsp;as&nbsp;</code><code class="type">xs:string</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="+">element(file)</xqdoc:type>+</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>docx<code class="as">&nbsp;as&nbsp;</code><code class="return-type">xs:string</code> the absolute path to the DOCX archive</li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">element(file) +</code>the absolute path(s) to the unzipped content</li></ul></dd><details><summary>Invokes 5 functions from 4 modules </summary><ul><li><span class="badge badge-warning" title="Externally defined">{http://expath.org/ns/file}exists#1</span></li><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}unzip-path#1" title="lib/style-check.xqm">sc:unzip-path#1</a></span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2001/XMLSchema}QName#1</span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2005/xpath-functions}error#2</span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2005/xpath-functions}resolve-uri#2</span></li></ul></details><details><summary>Invoked by 4 functions from 2 modules</summary><ul><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}build-manifest#1" title="lib/style-check.xqm">sc:build-manifest#1</a></span></li><li><span><a href="../../modules/F2/index.html#{http://www.andrewsales.com/style-check-tests}ensure-contents-pass#0" title="test/tests.xqm">sct:ensure-contents-pass#0</a></span></li><li><span><a href="../../modules/F2/index.html#{http://www.andrewsales.com/style-check-tests}ensure-contents-src#0" title="test/tests.xqm">sct:ensure-contents-src#0</a></span></li><li><span><a href="../../modules/F2/index.html#{http://www.andrewsales.com/style-check-tests}ensure-contents-fail#0" title="test/tests.xqm">sct:ensure-contents-fail#0</a></span></li></ul></details><details><summary>Source</summary><pre><code class="language-xquery">function sc:ensure-contents($docx as xs:string)
as element(file)+
{
  for $x in $sc:DOCX_CONTENT
  let $unzip-path := sc:unzip-path($docx)
  let $path := resolve-uri($x, $unzip-path)
  return
    if(file:exists($path))
    then &lt;file xml:base='file:/{$unzip-path}' src='{$x}'/&gt;
    else error(xs:QName('sc:docx-no-content'), 'no content found: '|| $path ||
  '; expected: ' || $x)
}</code></pre></details></div><div class="div3"><h3><a id="sc:ensure-file"></a><a id="{http://www.andrewsales.com/style-check}ensure-file#1"></a>4.5&nbsp;sc:ensure-file<div style="float:right"><a href="#sc:ensure-file">#</a></div></h3><p>Arities: <span style="margin-left:1em"><a href="#{http://www.andrewsales.com/style-check}ensure-file#1">sc:ensure-file#1</a></span></p><dt class="label">Summary</dt><dd>Ensure the file to be processed exists.</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">sc:ensure-file</code>
		  ( 
			<code class="arg">$path</code><code class="as">&nbsp;as&nbsp;</code><code class="type">xs:string</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="?">xs:string</xqdoc:type>?</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>path<code class="as">&nbsp;as&nbsp;</code><code class="return-type">xs:string</code> the file path</li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">xs:string ?</code></li></ul></dd><details><summary>Invokes 3 functions from 3 modules </summary><ul><li><span class="badge badge-warning" title="Externally defined">{http://expath.org/ns/file}exists#1</span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2001/XMLSchema}QName#1</span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2005/xpath-functions}error#2</span></li></ul></details><details><summary>Invoked by 3 functions from 2 modules</summary><ul><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}build-manifest#1" title="lib/style-check.xqm">sc:build-manifest#1</a></span></li><li><span><a href="../../modules/F2/index.html#{http://www.andrewsales.com/style-check-tests}ensure-file-pass#0" title="test/tests.xqm">sct:ensure-file-pass#0</a></span></li><li><span><a href="../../modules/F2/index.html#{http://www.andrewsales.com/style-check-tests}ensure-file-fail#0" title="test/tests.xqm">sct:ensure-file-fail#0</a></span></li></ul></details><details><summary>Source</summary><pre><code class="language-xquery">function sc:ensure-file($path as xs:string)
as xs:string?
{
  if(file:exists($path))
  then $path
  else error(xs:QName('sc:file-not-found'), 'cannot find file: '|| $path)
}</code></pre></details></div><div class="div3"><h3><a id="sc:ensure-format"></a><a id="{http://www.andrewsales.com/style-check}ensure-format#1"></a>4.6&nbsp;sc:ensure-format<div style="float:right"><a href="#sc:ensure-format">#</a></div></h3><p>Arities: <span style="margin-left:1em"><a href="#{http://www.andrewsales.com/style-check}ensure-format#1">sc:ensure-format#1</a></span></p><dt class="label">Summary</dt><dd>Ensure the file to be processed is in the correct format, by examining its
extension.</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">sc:ensure-format</code>
		  ( 
			<code class="arg">$path</code><code class="as">&nbsp;as&nbsp;</code><code class="type">xs:string</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="?">xs:string</xqdoc:type>?</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>path<code class="as">&nbsp;as&nbsp;</code><code class="return-type">xs:string</code> the file path</li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">xs:string ?</code></li></ul></dd><details><summary>Invokes 3 functions from 2 modules </summary><ul><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2001/XMLSchema}QName#1</span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2005/xpath-functions}ends-with#2</span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2005/xpath-functions}error#2</span></li></ul></details><details><summary>Invoked by 2 functions from 1 modules</summary><ul><li><span><a href="../../modules/F2/index.html#{http://www.andrewsales.com/style-check-tests}ensure-format-pass#0" title="test/tests.xqm">sct:ensure-format-pass#0</a></span></li><li><span><a href="../../modules/F2/index.html#{http://www.andrewsales.com/style-check-tests}ensure-format-fail#0" title="test/tests.xqm">sct:ensure-format-fail#0</a></span></li></ul></details><details><summary>Source</summary><pre><code class="language-xquery">function sc:ensure-format($path as xs:string)
as xs:string?
{
  if(ends-with($path, '.docx'))
  then $path
  else error(xs:QName('sc:invalid-format'), 'invalid format for file: '|| $path)
}</code></pre></details></div><div class="div3"><h3><a id="sc:simplify-styles"></a><a id="{http://www.andrewsales.com/style-check}simplify-styles#1"></a>4.7&nbsp;sc:simplify-styles<div style="float:right"><a href="#sc:simplify-styles">#</a></div></h3><p>Arities: <span style="margin-left:1em"><a href="#{http://www.andrewsales.com/style-check}simplify-styles#1">sc:simplify-styles#1</a></span></p><dt class="label">Summary</dt><dd>Batch-transform the manifest of files passed in.</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">sc:simplify-styles</code>
		  ( 
			<code class="arg">$manifest</code><code class="as">&nbsp;as&nbsp;</code><code class="type">element(files)</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0">element(files)</xqdoc:type></code></div></dd><dt class="label">Parameters</dt><dd><ul><li>manifest<code class="as">&nbsp;as&nbsp;</code><code class="return-type">element(files)</code> the manifest of files</li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">element(files)</code>the manifest, each document in the batch represented by <code xmlns:xqdoc="http://www.xqdoc.org/1.0">&lt;file src='...' dest='...'/&gt;</code></li></ul></dd><details><summary>Invokes 2 functions from 2 modules </summary><ul><li><span class="badge badge-warning" title="Externally defined">{http://basex.org/modules/xslt}transform#3</span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2005/xpath-functions}resolve-uri#1</span></li></ul></details><details><summary>Invoked by 1 functions from 1 modules</summary><ul><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}check#2" title="lib/style-check.xqm">sc:check#2</a></span></li></ul></details><details><summary>Source</summary><pre><code class="language-xquery">function sc:simplify-styles($manifest as element(files))
as element(files)
{
  xslt:transform(
    $manifest, 
    resolve-uri('../xsl/batch-transform.xsl'),	(:TODO: compile this to SEF too?:)
    map{'dtd-loc':$sc:STYLE_SCHEMA}
  )/files
}</code></pre></details></div><div class="div3"><h3><a id="sc:unzip"></a><a id="{http://www.andrewsales.com/style-check}unzip#1"></a>4.8&nbsp;sc:unzip<div style="float:right"><a href="#sc:unzip">#</a></div></h3><p>Arities: <span style="margin-left:1em"><a href="#{http://www.andrewsales.com/style-check}unzip#1">sc:unzip#1</a></span></p><dt class="label">Summary</dt><dd>Extract the contents of an archive representing a single word-processing
document.
In this implementation, only the document <code xmlns:xqdoc="http://www.xqdoc.org/1.0">word/document.xml</code> will be extracted,
to a directory named after the archive filename (minus extension).</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">sc:unzip</code>
		  ( 
			<code class="arg">$zip</code><code class="as">&nbsp;as&nbsp;</code><code class="type">xs:string</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0">empty-sequence()</xqdoc:type></code></div></dd><dt class="label">Parameters</dt><dd><ul><li>zip<code class="as">&nbsp;as&nbsp;</code><code class="return-type">xs:string</code> the word-processing document</li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">empty-sequence()</code></li></ul></dd><details><summary>Invokes 5 functions from 5 modules </summary><ul><li><span class="badge badge-warning" title="Externally defined">{http://basex.org/modules/archive}extract-to#3</span></li><li><span class="badge badge-warning" title="Externally defined">{http://expath.org/ns/file}read-binary#1</span></li><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}unzip-path#1" title="lib/style-check.xqm">sc:unzip-path#1</a></span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2001/XMLSchema}QName#1</span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2005/xpath-functions}error#2</span></li></ul></details><details><summary>Invoked by 2 functions from 1 modules</summary><ul><li><span><a href="../../modules/F2/index.html#{http://www.andrewsales.com/style-check-tests}unzip-pass#0" title="test/tests.xqm">sct:unzip-pass#0</a></span></li><li><span><a href="../../modules/F2/index.html#{http://www.andrewsales.com/style-check-tests}unzip-fail#0" title="test/tests.xqm">sct:unzip-fail#0</a></span></li></ul></details><details><summary>Source</summary><pre><code class="language-xquery">function sc:unzip($zip as xs:string)
as empty-sequence()
{
  try{
    archive:extract-to(
      sc:unzip-path($zip), 
      file:read-binary($zip), 
      $sc:DOCX_CONTENT
    )    
  }
  catch * {
    error(xs:QName('sc:docx-zip'), 'error unzipping '|| $zip || ' :' || 
      $err:description)
  }
}</code></pre></details></div><div class="div3"><h3><a id="sc:unzip-path"></a><a id="{http://www.andrewsales.com/style-check}unzip-path#1"></a>4.9&nbsp;sc:unzip-path<div style="float:right"><a href="#sc:unzip-path">#</a></div></h3><p>Arities: <span style="margin-left:1em"><a href="#{http://www.andrewsales.com/style-check}unzip-path#1">sc:unzip-path#1</a></span></p><dt class="label">Summary</dt><dd>Return the directory path where the DOCX contents are to be extracted.
This implementation uses the file name, minus extension.</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">sc:unzip-path</code>
		  ( 
			<code class="arg">$docx</code><code class="as">&nbsp;as&nbsp;</code><code class="type">xs:string</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0">xs:string</xqdoc:type></code></div></dd><dt class="label">Parameters</dt><dd><ul><li>docx<code class="as">&nbsp;as&nbsp;</code><code class="return-type">xs:string</code> absolute path to the DOCX file</li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">xs:string</code>path to the extraction directory</li></ul></dd><details><summary>Invokes 4 functions from 2 modules </summary><ul><li><span class="badge badge-warning" title="Externally defined">{http://expath.org/ns/file}parent#1</span></li><li><span class="badge badge-warning" title="Externally defined">{http://expath.org/ns/file}resolve-path#2</span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2005/xpath-functions}replace#6</span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2005/xpath-functions}substring-before#2</span></li></ul></details><details><summary>Invoked by 2 functions from 1 modules</summary><ul><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}unzip#1" title="lib/style-check.xqm">sc:unzip#1</a></span></li><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}ensure-contents#1" title="lib/style-check.xqm">sc:ensure-contents#1</a></span></li></ul></details><details><summary>Source</summary><pre><code class="language-xquery">function sc:unzip-path($docx as xs:string)
as xs:string
{
  file:resolve-path(substring-before($docx, '.docx'), file:parent($docx))
  =&gt; replace('\\', '/')
}</code></pre></details></div><div class="div3"><h3><a id="sc:validate"></a><a id="{http://www.andrewsales.com/style-check}validate#2"></a>4.10&nbsp;sc:validate<div style="float:right"><a href="#sc:validate">#</a></div></h3><p>Arities: <span style="margin-left:1em"><a href="#{http://www.andrewsales.com/style-check}validate#2">sc:validate#2</a></span></p><dt class="label">Summary</dt><dd>Process one or more word-processing documents.
Currently only DOCX format is supported.
If the option <code xmlns:xqdoc="http://www.xqdoc.org/1.0">halt-on-invalid</code> is set to <code xmlns:xqdoc="http://www.xqdoc.org/1.0">true()</code>, 
processing halts on the first invalid file.</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">sc:validate</code>
		  ( 
			<code class="arg">$manifest</code><code class="as">&nbsp;as&nbsp;</code><code class="type">element(files)</code>, <code class="arg">$options</code><code class="as">&nbsp;as&nbsp;</code><code class="type">map(*)</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0">element(result)</xqdoc:type></code></div></dd><dt class="label">Parameters</dt><dd><ul><li>manifest<code class="as">&nbsp;as&nbsp;</code><code class="return-type">element(files)</code> of files to be validated</li><li>options<code class="as">&nbsp;as&nbsp;</code><code class="return-type">map(*)</code> map of options</li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">element(result)</code>one error report per file validated</li></ul></dd><details><summary>Invokes 6 functions from 3 modules </summary><ul><li><span class="badge badge-warning" title="Externally defined">{http://basex.org/modules/proc}execute#2</span></li><li><span><a href="../../modules/F1/index.html#{http://www.andrewsales.com/style-check}debug#2" title="lib/style-check.xqm">sc:debug#2</a></span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2005/xpath-functions}data#1</span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2005/xpath-functions}resolve-uri#1</span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2005/xpath-functions}string-join#2</span></li><li><span class="badge badge-warning" title="Externally defined">{http://www.w3.org/2005/xpath-functions}substring-after#4</span></li></ul></details><details><summary>Invoked by 3 functions from 1 modules</summary><ul><li><span><a href="../../modules/F2/index.html#{http://www.andrewsales.com/style-check-tests}validate-no-errors#0" title="test/tests.xqm">sct:validate-no-errors#0</a></span></li><li><span><a href="../../modules/F2/index.html#{http://www.andrewsales.com/style-check-tests}validate-errors#0" title="test/tests.xqm">sct:validate-errors#0</a></span></li><li><span><a href="../../modules/F2/index.html#{http://www.andrewsales.com/style-check-tests}validate-multiple#0" title="test/tests.xqm">sct:validate-multiple#0</a></span></li></ul></details><details><summary>Source</summary><pre><code class="language-xquery">function sc:validate(
  $manifest as element(files),
  $options as map(*)
)
as element(result)
{
  let $_ := sc:debug('validate paths='||
    string-join($manifest/file/@dest, ' '), $options)
  return
  proc:execute(
    'java',
    (
      '-jar', resolve-uri('../etc/validator.jar')=&gt;substring-after('file:///'),
      $manifest/file/@dest ! data(),
      if($options ? ($sc:HALT_ON_INVALID)) then '--'||$sc:HALT_ON_INVALID else ()
    )
  )
}</code></pre></details></div></section><section id="namespaces"><h2>Namespaces</h2><p>The following namespaces are defined:</p><table class="data" style="float:none"><thead><tr><th>Prefix</th><th>Uri</th></tr></thead><tbody><tr><td>ann</td><td><span class="badge badge-warning" title="Externally defined">http://www.w3.org/2012/xquery</span></td></tr><tr><td>sc</td><td><span><a href="../../modules/F1/index.html" title="lib/style-check.xqm">http://www.andrewsales.com/style-check</a></span></td></tr></tbody></table></section><div class="div2"><h2><a id="restxq"></a>6 RestXQ</h2><p>None</p></div><section id="source"><h2>Source Code</h2><pre><code class="language-xquery">(:~ 
 : &lt;p&gt;Module of BaseX XQuery functions to provide style-checking functionality
 : for Microsoft Word documents.&lt;/p&gt;
 : 
 : &lt;p&gt;Tested under BaseX 9.5.&lt;/p&gt;
 : The target Word XML format is that in the namespace:
 : 	&lt;code&gt;http://schemas.openxmlformats.org/wordprocessingml/2006/main&lt;/code&gt;.
 :
 : &lt;p&gt;The main entry point is sc:check(), which takes one or more paths to *.docx
 : documents. Each of these is unzipped, simplified to consist of elements
 : describing paragraph and inline styles, then validated against the style
 : DTD - see path given in $sc:STYLE_SCHEMA.&lt;/p&gt;
 :
 : &lt;h2&gt;APPROACH&lt;/h2&gt;
 : &lt;ol&gt;&lt;li&gt;does path exist?&lt;/li&gt;
 : &lt;li&gt;is it a DOCX?&lt;/li&gt;
 : &lt;li&gt;is it a valid zip?&lt;/li&gt;
 : &lt;li&gt;unzip it&lt;/li&gt;
 : &lt;li&gt;is it a valid DOCX (does it contain &lt;code&gt;word/document.xml&lt;/code&gt;)?&lt;/li&gt;
 : &lt;li&gt;transform it to simplified styles&lt;/li&gt;
 : &lt;li&gt;validate the result with custom validator&lt;/li&gt;
 : &lt;li&gt;return the resulting report&lt;/li&gt;
 : &lt;/ol&gt;
 :
 : &lt;p&gt;TODO: use &lt;code&gt;$sc:UNZIP_DIR&lt;/code&gt;&lt;/p&gt;
 :)

module namespace sc = "http://www.andrewsales.com/style-check";

(:~ where the contents of the DOCX will be extracted to (not currently used) :)
declare variable $sc:UNZIP_DIR external := '.';
(:~ the zip entries to be extracted from DOCX :)
declare variable $sc:DOCX_CONTENT as element(archive:entry)+ := 
  &lt;archive:entry&gt;word/document.xml&lt;/archive:entry&gt;;	(:expected zip entries:)
(:~ location of the style schema applied during validation :)
declare variable $sc:STYLE_SCHEMA as xs:anyURI external := 
  resolve-uri('../dtd/style-schema.dtd');
(:~ debugging flag :)  
declare variable $sc:OPT_DEBUG as xs:string := 'debug';
(:~ string of the halt-on-invalid validation option :)
declare variable $sc:HALT_ON_INVALID as xs:string := 'halt-on-invalid';

(:~ 
 : Process one or more word-processing documents.
 : Currently only DOCX format is supported.
 : Options are: 
 : &lt;ul&gt;&lt;li&gt;debug (Boolean): whether to emit debugging messages via trace()&lt;/li&gt;
 : &lt;li&gt;halt-on-invalid (Boolean): whether to halt processing on the first invalid 
 : document returned by &lt;code&gt;sc:validate()&lt;/code&gt;&lt;/li&gt;&lt;/ul&gt;
 :
 : @param docs the absolute URI(s) of the document(s) to process
 : @param options map of options
 : @return manifest of file paths for further processing
 :)
declare function sc:check(
  $docs as xs:string+,
  $options as map(*)
)
{
  let $_ := sc:debug('check(): ' || string-join($docs, ' '), $options)
  let $manifest := sc:build-manifest($docs)
  let $_ := sc:debug('manifest=' || $manifest, $options)
  return sc:simplify-styles($manifest) =&gt; sc:validate($options)
};

(:~ 
 : Process one or more word-processing documents.
 : Currently only DOCX format is supported.
 : If the option &lt;code&gt;halt-on-invalid&lt;/code&gt; is set to &lt;code&gt;true()&lt;/code&gt;, 
 : processing halts on the first invalid file.
 : @param manifest of files to be validated
 : @param options map of options
 : @return one error report per file validated
 :)
declare function sc:validate(
  $manifest as element(files),
  $options as map(*)
)
as element(result)
{
  let $_ := sc:debug('validate paths='||
    string-join($manifest/file/@dest, ' '), $options)
  return
  proc:execute(
    'java',
    (
      '-jar', resolve-uri('../etc/validator.jar')=&gt;substring-after('file:///'),
      $manifest/file/@dest ! data(),
      if($options ? ($sc:HALT_ON_INVALID)) then '--'||$sc:HALT_ON_INVALID else ()
    )
  )
};

(:~ Build the manifest for the Word XML files extracted. 
 : @param docs the absolute URI(s) of the document(s) to process
 : @return the manifest, each document in the batch represented by &lt;code&gt;&amp;lt;file src='...'/&gt;&lt;/code&gt;
 :)
declare function sc:build-manifest($docs as xs:string+)
as element(files)
{
  &lt;files&gt;{
    $docs !
    (
      sc:ensure-file(.) =&gt; sc:ensure-format() =&gt; sc:unzip(),
      sc:ensure-contents(.)
    )
  }&lt;/files&gt;
};

(:~ Batch-transform the manifest of files passed in.
 : @param manifest the manifest of files
 : @return the manifest, each document in the batch represented by &lt;code&gt;&amp;lt;file src='...' dest='...'/&gt;&lt;/code&gt;
 :)
declare function sc:simplify-styles($manifest as element(files))
as element(files)
{
  xslt:transform(
    $manifest, 
    resolve-uri('../xsl/batch-transform.xsl'),	(:TODO: compile this to SEF too?:)
    map{'dtd-loc':$sc:STYLE_SCHEMA}
  )/files
};

(:~ Ensure the file to be processed exists.
 : @param path the file path
 :)
declare function sc:ensure-file($path as xs:string)
as xs:string?
{
  if(file:exists($path))
  then $path
  else error(xs:QName('sc:file-not-found'), 'cannot find file: '|| $path)
};

(:~ Ensure the file to be processed is in the correct format, by examining its
 : extension.
 : @param path the file path
 :)
declare function sc:ensure-format($path as xs:string)
as xs:string?
{
  if(ends-with($path, '.docx'))
  then $path
  else error(xs:QName('sc:invalid-format'), 'invalid format for file: '|| $path)
};

(:~ 
 : Extract the contents of an archive representing a single word-processing
 : document.
 : In this implementation, only the document &lt;code&gt;word/document.xml&lt;/code&gt; will be extracted,
 : to a directory named after the archive filename (minus extension).
 : @param zip the word-processing document
 :)
declare function sc:unzip($zip as xs:string)
as empty-sequence()
{
  try{
    archive:extract-to(
      sc:unzip-path($zip), 
      file:read-binary($zip), 
      $sc:DOCX_CONTENT
    )    
  }
  catch * {
    error(xs:QName('sc:docx-zip'), 'error unzipping '|| $zip || ' :' || 
      $err:description)
  }
};

(:~ 
 : Check that all expected content is present in the DOCX archive.
 : @param docx the absolute path to the DOCX archive
 : @return the absolute path(s) to the unzipped content
 :)
declare function sc:ensure-contents($docx as xs:string)
as element(file)+
{
  for $x in $sc:DOCX_CONTENT
  let $unzip-path := sc:unzip-path($docx)
  let $path := resolve-uri($x, $unzip-path)
  return
    if(file:exists($path))
    then &lt;file xml:base='file:/{$unzip-path}' src='{$x}'/&gt;
    else error(xs:QName('sc:docx-no-content'), 'no content found: '|| $path ||
  '; expected: ' || $x)
};

(:~ 
 : Return the directory path where the DOCX contents are to be extracted.
 : This implementation uses the file name, minus extension.
 : @param docx absolute path to the DOCX file
 : @return path to the extraction directory
 :)
declare function sc:unzip-path($docx as xs:string)
as xs:string
{
  file:resolve-path(substring-before($docx, '.docx'), file:parent($docx))
  =&gt; replace('\\', '/')
};

(:~ Emit debugging messages to the console.
 : @param msg the contents of the message to display
 : @param options map of options (if 'debug' is set to true(), messages are 
 : emitted)
 :)
declare %private function sc:debug($msg as item()*, $options as map(*))
{
  if($options?($sc:OPT_DEBUG))
  then trace('[DEBUG]:' || $msg)
  else ()
};</code></pre></section></div></div><div class="footer"><p style="text-align:right">Generated by 
            <a href="https://github.com/Quodatum/xqdoca" target="_blank">xqDocA</a>
            &nbsp; 0.2 on <span title="2021-08-20T13:27:42.243+01:00">Friday, August 20th 2021</span></p></div><script src="../../resources/prism/prism.js" type="text/javascript"></script><script src="../../resources/xqdoca.js" type="text/javascript"></script></body></html>